import struct
import itertools

import numpy as np
from bitarray import bitarray


RANDOM_SEED = 2387613

IMAGE_SIZE = 128
BATCH_SIZE = 2048

# Assign an integer to each word to be predicted.
WORD2LABEL = {
    'The Eiffel Tower': 0,
    'The Great Wall of China': 1,
    'The Mona Lisa': 2,
    'airplane': 3,
    'alarm clock': 4,
    'ambulance': 5,
    'angel': 6,
    'animal migration': 7,
    'ant': 8,
    'anvil': 9,
    'apple': 10,
    'arm': 11,
    'asparagus': 12,
    'axe': 13,
    'backpack': 14,
    'banana': 15,
    'bandage': 16,
    'barn': 17,
    'baseball': 19,
    'baseball bat': 18,
    'basket': 20,
    'basketball': 21,
    'bat': 22,
    'bathtub': 23,
    'beach': 24,
    'bear': 25,
    'beard': 26,
    'bed': 27,
    'bee': 28,
    'belt': 29,
    'bench': 30,
    'bicycle': 31,
    'binoculars': 32,
    'bird': 33,
    'birthday cake': 34,
    'blackberry': 35,
    'blueberry': 36,
    'book': 37,
    'boomerang': 38,
    'bottlecap': 39,
    'bowtie': 40,
    'bracelet': 41,
    'brain': 42,
    'bread': 43,
    'bridge': 44,
    'broccoli': 45,
    'broom': 46,
    'bucket': 47,
    'bulldozer': 48,
    'bus': 49,
    'bush': 50,
    'butterfly': 51,
    'cactus': 52,
    'cake': 53,
    'calculator': 54,
    'calendar': 55,
    'camel': 56,
    'camera': 57,
    'camouflage': 58,
    'campfire': 59,
    'candle': 60,
    'cannon': 61,
    'canoe': 62,
    'car': 63,
    'carrot': 64,
    'castle': 65,
    'cat': 66,
    'ceiling fan': 67,
    'cell phone': 68,
    'cello': 69,
    'chair': 70,
    'chandelier': 71,
    'church': 72,
    'circle': 73,
    'clarinet': 74,
    'clock': 75,
    'cloud': 76,
    'coffee cup': 77,
    'compass': 78,
    'computer': 79,
    'cookie': 80,
    'cooler': 81,
    'couch': 82,
    'cow': 83,
    'crab': 84,
    'crayon': 85,
    'crocodile': 86,
    'crown': 87,
    'cruise ship': 88,
    'cup': 89,
    'diamond': 90,
    'dishwasher': 91,
    'diving board': 92,
    'dog': 93,
    'dolphin': 94,
    'donut': 95,
    'door': 96,
    'dragon': 97,
    'dresser': 98,
    'drill': 99,
    'drums': 100,
    'duck': 101,
    'dumbbell': 102,
    'ear': 103,
    'elbow': 104,
    'elephant': 105,
    'envelope': 106,
    'eraser': 107,
    'eye': 108,
    'eyeglasses': 109,
    'face': 110,
    'fan': 111,
    'feather': 112,
    'fence': 113,
    'finger': 114,
    'fire hydrant': 115,
    'fireplace': 116,
    'firetruck': 117,
    'fish': 118,
    'flamingo': 119,
    'flashlight': 120,
    'flip flops': 121,
    'floor lamp': 122,
    'flower': 123,
    'flying saucer': 124,
    'foot': 125,
    'fork': 126,
    'frog': 127,
    'frying pan': 128,
    'garden': 130,
    'garden hose': 129,
    'giraffe': 131,
    'goatee': 132,
    'golf club': 133,
    'grapes': 134,
    'grass': 135,
    'guitar': 136,
    'hamburger': 137,
    'hammer': 138,
    'hand': 139,
    'harp': 140,
    'hat': 141,
    'headphones': 142,
    'hedgehog': 143,
    'helicopter': 144,
    'helmet': 145,
    'hexagon': 146,
    'hockey puck': 147,
    'hockey stick': 148,
    'horse': 149,
    'hospital': 150,
    'hot air balloon': 151,
    'hot dog': 152,
    'hot tub': 153,
    'hourglass': 154,
    'house': 156,
    'house plant': 155,
    'hurricane': 157,
    'ice cream': 158,
    'jacket': 159,
    'jail': 160,
    'kangaroo': 161,
    'key': 162,
    'keyboard': 163,
    'knee': 164,
    'ladder': 165,
    'lantern': 166,
    'laptop': 167,
    'leaf': 168,
    'leg': 169,
    'light bulb': 170,
    'lighthouse': 171,
    'lightning': 172,
    'line': 173,
    'lion': 174,
    'lipstick': 175,
    'lobster': 176,
    'lollipop': 177,
    'mailbox': 178,
    'map': 179,
    'marker': 180,
    'matches': 181,
    'megaphone': 182,
    'mermaid': 183,
    'microphone': 184,
    'microwave': 185,
    'monkey': 186,
    'moon': 187,
    'mosquito': 188,
    'motorbike': 189,
    'mountain': 190,
    'mouse': 191,
    'moustache': 192,
    'mouth': 193,
    'mug': 194,
    'mushroom': 195,
    'nail': 196,
    'necklace': 197,
    'nose': 198,
    'ocean': 199,
    'octagon': 200,
    'octopus': 201,
    'onion': 202,
    'oven': 203,
    'owl': 204,
    'paint can': 205,
    'paintbrush': 206,
    'palm tree': 207,
    'panda': 208,
    'pants': 209,
    'paper clip': 210,
    'parachute': 211,
    'parrot': 212,
    'passport': 213,
    'peanut': 214,
    'pear': 215,
    'peas': 216,
    'pencil': 217,
    'penguin': 218,
    'piano': 219,
    'pickup truck': 220,
    'picture frame': 221,
    'pig': 222,
    'pillow': 223,
    'pineapple': 224,
    'pizza': 225,
    'pliers': 226,
    'police car': 227,
    'pond': 228,
    'pool': 229,
    'popsicle': 230,
    'postcard': 231,
    'potato': 232,
    'power outlet': 233,
    'purse': 234,
    'rabbit': 235,
    'raccoon': 236,
    'radio': 237,
    'rain': 238,
    'rainbow': 239,
    'rake': 240,
    'remote control': 241,
    'rhinoceros': 242,
    'river': 243,
    'roller coaster': 244,
    'rollerskates': 245,
    'sailboat': 246,
    'sandwich': 247,
    'saw': 248,
    'saxophone': 249,
    'school bus': 250,
    'scissors': 251,
    'scorpion': 252,
    'screwdriver': 253,
    'sea turtle': 254,
    'see saw': 255,
    'shark': 256,
    'sheep': 257,
    'shoe': 258,
    'shorts': 259,
    'shovel': 260,
    'sink': 261,
    'skateboard': 262,
    'skull': 263,
    'skyscraper': 264,
    'sleeping bag': 265,
    'smiley face': 266,
    'snail': 267,
    'snake': 268,
    'snorkel': 269,
    'snowflake': 270,
    'snowman': 271,
    'soccer ball': 272,
    'sock': 273,
    'speedboat': 274,
    'spider': 275,
    'spoon': 276,
    'spreadsheet': 277,
    'square': 278,
    'squiggle': 279,
    'squirrel': 280,
    'stairs': 281,
    'star': 282,
    'steak': 283,
    'stereo': 284,
    'stethoscope': 285,
    'stitches': 286,
    'stop sign': 287,
    'stove': 288,
    'strawberry': 289,
    'streetlight': 290,
    'string bean': 291,
    'submarine': 292,
    'suitcase': 293,
    'sun': 294,
    'swan': 295,
    'sweater': 296,
    'swing set': 297,
    'sword': 298,
    't-shirt': 299,
    'table': 300,
    'teapot': 301,
    'teddy-bear': 302,
    'telephone': 303,
    'television': 304,
    'tennis racquet': 305,
    'tent': 306,
    'tiger': 307,
    'toaster': 308,
    'toe': 309,
    'toilet': 310,
    'tooth': 311,
    'toothbrush': 312,
    'toothpaste': 313,
    'tornado': 314,
    'tractor': 315,
    'traffic light': 316,
    'train': 317,
    'tree': 318,
    'triangle': 319,
    'trombone': 320,
    'truck': 321,
    'trumpet': 322,
    'umbrella': 323,
    'underwear': 324,
    'van': 325,
    'vase': 326,
    'violin': 327,
    'washing machine': 328,
    'watermelon': 329,
    'waterslide': 330,
    'whale': 331,
    'wheel': 332,
    'windmill': 333,
    'wine bottle': 334,
    'wine glass': 335,
    'wristwatch': 336,
    'yoga': 337,
    'zebra': 338,
    'zigzag': 339,
}

LABEL2WORD = dict((v, k) for k, v in WORD2LABEL.items())


def pack_example(image, label, fout):
    image_as_bits = bitarray(image.flatten().tolist())
    fout.write(image_as_bits.tobytes())
    fout.write(struct.pack('H', label))

def unpack_example(fin):
    image_size = IMAGE_SIZE * IMAGE_SIZE // 8  # bytes
    image_as_bits = bitarray()
    image_as_bits.fromfile(fin, image_size)
    image_as_bytes = np.frombuffer(image_as_bits.tobytes(), count=image_size, dtype=np.uint8)
    image = np.unpackbits(image_as_bytes).astype(np.float32).reshape(IMAGE_SIZE, IMAGE_SIZE, 1)
    label, = struct.unpack('H', fin.read(2))
    return {'image': image, 'label': label}

def unpack_examples(fin):
    while True:
        try:
            yield unpack_example(fin)
        except (EOFError, struct.error):
            break


# https://docs.python.org/3/library/itertools.html#recipes
def roundrobin(iterables):
    num_active = len(iterables)
    nexts = itertools.cycle(iter(it).__next__ for it in iterables)
    while num_active:
        try:
            for next in nexts:
                yield next()
        except StopIteration:
            # Remove the iterator we just exhausted from the cycle.
            num_active -= 1
            nexts = itertools.cycle(itertools.islice(nexts, num_active))
